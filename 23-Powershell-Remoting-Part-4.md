#### 23. Powershell Remoting Part 4

###### PowerShell Remoting – One-to-Many

- ```Invoke-Command```

    - Running ```Commands```
    
	```PowerShell
	PS C:\Users\Administrator> Invoke-Command -ScriptBlock {whoami;(Get-Host).Version;Get-Process} -ComputerName JOHN-PC -Credential John-PC\John
	john-pc\john
	
	Major  Minor  Build  Revision PSComputerName
	-----  -----  -----  -------- --------------
	1      0      0      0        JOHN-PC
	
	Id             : 1288
	Handles        : 23
	CPU            : 0
	Name           : cmd
	PSComputerName : JOHN-PC
	
	
	Id             : 1552
	Handles        : 22
	CPU            : 0.0100144
	Name           : cmd
	PSComputerName : JOHN-PC
	
	
	Id             : 1220
	Handles        : 40
	CPU            : 0.050072
	Name           : conhost
	PSComputerName : JOHN-PC
	
	
	Id             : 3124
	Handles        : 34
	CPU            : 0
	Name           : conhost
	PSComputerName : JOHN-PC
	
	
	Id             : 352
	Handles        : 433
	CPU            : 0.100144
	Name           : csrss
	PSComputerName : JOHN-PC
	
	
	Id             : 408
	Handles        : 206
	CPU            : 0.4706768
	Name           : csrss
	PSComputerName : JOHN-PC
	
	
	Id             : 2920
	Handles        : 79
	CPU            : 0.0100144
	Name           : dllhost
	PSComputerName : JOHN-PC
	
	
	Id             : 912
	Handles        : 66
	CPU            : 0.0200288
	Name           : dwm
	PSComputerName : JOHN-PC
	
	
	Id             : 696
	Handles        : 786
	CPU            : 2.9342192
	Name           : explorer
	PSComputerName : JOHN-PC
	
	
	Id             : 0
	Handles        : 0
	CPU            :
	Name           : Idle
	PSComputerName : JOHN-PC
	
	
	Id             : 492
	Handles        : 744
	CPU            : 0.901296
	Name           : lsass
	PSComputerName : JOHN-PC
	
	
	Id             : 500
	Handles        : 196
	CPU            : 0.0701008
	Name           : lsm
	PSComputerName : JOHN-PC
	
	
	Id             : 3160
	Handles        : 56
	CPU            : 0.0701008
	Name           : notepad
	PSComputerName : JOHN-PC
	
	
	Id             : 2924
	Handles        : 134
	CPU            : 0.1301872
	Name           : python
	PSComputerName : JOHN-PC
	
	
	Id             : 1664
	Handles        : 627
	CPU            : 0.50072
	Name           : SearchIndexer
	PSComputerName : JOHN-PC
	
	
	Id             : 476
	Handles        : 199
	CPU            : 0.7310512
	Name           : services
	PSComputerName : JOHN-PC
	
	
	Id             : 272
	Handles        : 29
	CPU            : 0.0600864
	Name           : smss
	PSComputerName : JOHN-PC
	
	
	Id             : 1356
	Handles        : 280
	CPU            : 0.0200288
	Name           : spoolsv
	PSComputerName : JOHN-PC
	
	
	Id             : 624
	Handles        : 354
	CPU            : 0.3605184
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 736
	Handles        : 267
	CPU            : 0.3304752
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 788
	Handles        : 550
	CPU            : 0.50072
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 872
	Handles        : 514
	CPU            : 3.50504
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 960
	Handles        : 1142
	CPU            : 3.5150544
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 1124
	Handles        : 452
	CPU            : 0.4706768
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 1232
	Handles        : 696
	CPU            : 0.6609504
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 1392
	Handles        : 306
	CPU            : 0.5708208
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 1500
	Handles        : 349
	CPU            : 0.200288
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 1956
	Handles        : 373
	CPU            : 11.3262864
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 2772
	Handles        : 344
	CPU            : 0.9413536
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 3816
	Handles        : 96
	CPU            : 0.0300432
	Name           : svchost
	PSComputerName : JOHN-PC
	
	
	Id             : 4
	Handles        : 565
	CPU            :
	Name           : System
	PSComputerName : JOHN-PC
	
	
	Id             : 1292
	Handles        : 138
	CPU            : 0.050072
	Name           : taskhost
	PSComputerName : JOHN-PC
	
	
	Id             : 3528
	Handles        : 149
	CPU            : 0.0600864
	Name           : taskhost
	PSComputerName : JOHN-PC
	
	
	Id             : 684
	Handles        : 115
	CPU            : 0.25036
	Name           : VBoxService
	PSComputerName : JOHN-PC
	
	
	Id             : 2104
	Handles        : 140
	CPU            : 0.0600864
	Name           : VBoxTray
	PSComputerName : JOHN-PC
	
	
	Id             : 400
	Handles        : 74
	CPU            : 0.2303312
	Name           : wininit
	PSComputerName : JOHN-PC
	
	
	Id             : 448
	Handles        : 113
	CPU            : 0.2703888
	Name           : winlogon
	PSComputerName : JOHN-PC
	
	
	Id             : 556
	Handles        : 417
	CPU            : 0.4105904
	Name           : wmpnetwk
	PSComputerName : JOHN-PC
	
	
	Id             : 3532
	Handles        : 247
	CPU            : 0.7711088
	Name           : wsmprovhost
	PSComputerName : JOHN-PC
	
	
	
	PS C:\Users\Administrator>
	```

    - Running ```Scripts```

	```PowerShell
	PS C:\Users\Administrator\Desktop> Invoke-Command -FilePath .\HelloWorld.ps1 -ComputerName JOHN-PC -Credential John-PC\John
	Hello World
	PS C:\Users\Administrator\Desktop>
	```
	
	```PowerShell
	PS C:\Users\Administrator\Desktop> Invoke-Command -FilePath .\nishang-master\Gather\Check-VM.ps1 -ComputerName JOHN-PC -Credential John-PC\John
	```

    - Running ```Modules```
    
        - Import the ```Module```
    
		```PowerShell
		PS C:\Users\Administrator\Desktop> Import-Module .\nishang-master\powerpreter\Powerpreter.psm1
		WARNING: The names of some imported commands from the module 'Powerpreter' include unapproved verbs that might make them less discoverable. To find the commands with unapproved verbs, run the
		Import-Module command again with the Verbose parameter. For a list of approved verbs, type Get-Verb.
		WARNING: Some imported command names contain one or more of the following restricted characters: # , ( ) {{ }} [ ] & - / \ $ ^ ; : " ' < > | ? @ ` * % + = ~
		PS C:\Users\Administrator\Desktop>
		```
		
		- Check that the ```Module``` is imported

		```PowerShell
		PS C:\Users\Administrator\Desktop> Get-Module
		
		ModuleType Version    Name                                ExportedCommands
		---------- -------    ----                                ----------------
		Manifest   3.1.0.0    Microsoft.PowerShell.Management     {Add-Computer, Add-Content, Checkpoint-Computer, Clear-Content...}
		Manifest   3.0.0.0    Microsoft.PowerShell.Security       {ConvertFrom-SecureString, ConvertTo-SecureString, Get-Acl, Get-AuthenticodeSignature...}
		Manifest   3.1.0.0    Microsoft.PowerShell.Utility        {Add-Member, Add-Type, Clear-Variable, Compare-Object...}
		Manifest   3.0.0.0    Microsoft.WSMan.Management          {Connect-WSMan, Disable-WSManCredSSP, Disconnect-WSMan, Enable-WSManCredSSP...}
		Script     0.0        Powerpreter                         {Add-ScrnSaveBackdoor, Base64ToString, Check-VM, Copy-VSS...}
		
		PS C:\Users\Administrator\Desktop>
		```
		
		- List the ```Functions``` of the ```Module```

		```PowerShell
		PS C:\Users\Administrator\Desktop> Get-Command -Module Powerpreter
		
		CommandType     Name                                               ModuleName
		-----------     ----                                               ----------
		Function        Add-ScrnSaveBackdoor                               Powerpreter
		Function        Base64ToString                                     Powerpreter
		Function        Check-VM                                           Powerpreter
		Function        Copy-VSS                                           Powerpreter
		Function        Create-MultipleSessions                            Powerpreter
		Function        DNS_TXT_Pwnage                                     Powerpreter
		Function        Do-Exfiltration                                    Powerpreter
		Function        Download                                           Powerpreter
		Function        Download_Execute                                   Powerpreter
		Function        Download-Execute-PS                                Powerpreter
		Function        Enable-DuplicateToken                              Powerpreter
		Function        Execute-Command-MSSQL                              Powerpreter
		Function        Execute-DNSTXT-Code                                Powerpreter
		Function        Execute-OnTime                                     Powerpreter
		Function        ExetoText                                          Powerpreter
		Function        FireBuster                                         Powerpreter
		Function        FireListener                                       Powerpreter
		Function        Get-Information                                    Powerpreter
		Function        Get-LsaSecret                                      Powerpreter
		Function        Get-PassHashes                                     Powerpreter
		Function        Get-PassHints                                      Powerpreter
		Function        Get-Wlan-Keys                                      Powerpreter
		Function        Gupt-Backdoor                                      Powerpreter
		Function        HTTP-Backdoor                                      Powerpreter
		Function        Invoke-BruteForce                                  Powerpreter
		Function        Invoke-CredentialsPhish                            Powerpreter
		Function        Invoke-Decode                                      Powerpreter
		Function        Invoke-Encode                                      Powerpreter
		Function        Invoke-NetworkRelay                                Powerpreter
		Function        Invoke-PortScan                                    Powerpreter
		Function        Invoke-PSGcat                                      Powerpreter
		Function        Invoke-PsGcatAgent                                 Powerpreter
		Function        Invoke-PsUACme                                     Powerpreter
		Function        Keylogger                                          Powerpreter
		Function        Out-CHM                                            Powerpreter
		Function        Out-DnsTxt                                         Powerpreter
		Function        Out-Excel                                          Powerpreter
		Function        Out-HTA                                            Powerpreter
		Function        Out-Java                                           Powerpreter
		Function        Out-Shortcut                                       Powerpreter
		Function        Out-WebQuery                                       Powerpreter
		Function        Out-Word                                           Powerpreter
		Function        Persistence                                        Powerpreter
		Function        Pivot                                              Powerpreter
		Function        Remove-Persistence                                 Powerpreter
		Function        Remove-Update                                      Powerpreter
		Function        StringtoBase64                                     Powerpreter
		Function        TexttoEXE                                          Powerpreter
		Function        Use-Session                                        Powerpreter
		
		PS C:\Users\Administrator\Desktop>
		```
		
		- Run the ```Function``` of the ```Module```

		```PowerShell
		PS C:\Users\Administrator\Desktop> Invoke-Command -ScriptBlock ${Function:Get-WLAN-Keys} -ComputerName JOHN-PC -Credential John-PC\John
		You cannot call a method on a null-valued expression.
		    + CategoryInfo          : InvalidOperation: (Replace:String) [], RuntimeException
		    + FullyQualifiedErrorId : InvokeMethodOnNull
		    + PSComputerName        : JOHN-PC
		
		The Wireless AutoConfig Service (wlansvc) is not running.
		PS C:\Users\Administrator\Desktop>
		```
		
- “Fan-Out” or “One-to-Many”

```PowerShell
Invoke-Command -ScriptBlock {whoami;(Get-Host).Version;Get-Process} -ComputerName <DOMAIN_PC>,<DOMAIN_CONTROLLER> -Credential <DOMAIN_NAME>\Administrator
```

```PowerShell
Invoke-Command -ScriptBlock {whoami;(Get-Host).Version;Get-Process} -ComputerName {Get-Content .\servers.txt} -Credential <DOMAIN_NAME>\Administrator
```

###### Exercise

- Write a ```PowerShell``` script which searches for the presence of strings like ```“password”```, ```“username”``` and ```“credentials”``` in the ```C:\``` directory.
- Run this script on remote machines.
